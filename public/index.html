<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>SmileSionã®å°æ¯’èˆŒ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .review-container {
      max-width: 800px;
      margin: 0 auto;
      font-family: "Microsoft YaHei", sans-serif;
      line-height: 1.6;
      color: #333;
    }
    
    /* å‡å°æ®µè½çš„ä¸Šä¸‹è¾¹è· */
    .review-container p {
      margin-top: 0.5em;
      margin-bottom: 0.5em;
    }
    
    /* ç²¾ç®€ ul å’Œ li çš„ç©ºéš™ */
    .review-container ul {
      padding-left: 1.2em;
      margin-top: 0.5em;
      margin-bottom: 0.5em;
    }
    
    .review-container li {
      margin-bottom: 0.3em;
    }
    
    /* ä¼˜åŒ– hr åˆ†å‰²çº¿æ ·å¼ */
    .review-container hr {
      border: none;
      border-top: 1px solid #ddd;
      margin: 1em 0;
    }
    
    /* æ ‡é¢˜é—´è·å¾®è°ƒ */
    .review-container h3, .review-container h4 {
      margin-top: 1em;
      margin-bottom: 0.5em;
    }
    /* ä¸»å†…å®¹åŒºåŸŸæ ·å¼ */
    #reportContent {
      min-height: 300px;
      max-height: 500px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      white-space: pre-wrap;
      line-height: 1.6;
      font-size: 0.9375rem;
    }
    
    /* è¿›åº¦æ¡æ ·å¼ */
    .progress-bar {
      height: 4px;
      background-color: #3b82f6;
      transition: width 0.3s ease;
    }
    
    /* æ¸¸æˆé¡¹ç®€æ´æ ·å¼ */
    .game-item {
      padding: 3px 6px;
      margin: 1px 0;
      font-size: 0.8125rem;
      border-left: 2px solid #3b82f6;
      background-color: #f8fafc;
      display: inline-block;
      margin-right: 6px;
      margin-bottom: 4px;
      border-radius: 0.125rem;
    }
    
    /* æˆªå›¾ä¸“ç”¨éšè—åŒºåŸŸ */
    #report-for-capture {
      width: 650px;
      padding: 24px;
      background-color: white;
      position: absolute;
      left: -9999px;
      font-family: "Microsoft YaHei", sans-serif;
      line-height: 1.6;
      font-size: 0.9375rem;
      color: #333;
    }
    
    
    /* æˆªå›¾åŒºåŸŸæ–‡æœ¬æ ·å¼ */
    #report-for-capture #reportContent-capture {
      white-space: pre-wrap;
      font-size: 0.9375rem; /* åŒé¡µé¢ */
      line-height: 1.6;
      color: #333;
    }    
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div class="max-w-3xl mx-auto py-10">
    <h1 class="text-3xl font-bold text-center mb-6">ğŸ® SmileSionã®å°æ¯’èˆŒ</h1>

    <div class="bg-white shadow-md rounded p-6">
      <label class="block mb-2 text-lg font-semibold">è¯·è¾“å…¥Steamç”¨æˆ·IDï¼š</label>
      <input id="steamIdInput" class="w-full p-3 border rounded mb-4" placeholder="ä¾‹å¦‚ï¼š76561198403581191">
      
      <button id="generateBtn" onclick="checkExistingData()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">
        ç”ŸæˆæŠ¥å‘Š
      </button>

      <div id="loading" class="mt-4 hidden">
        <div class="flex items-center mb-2">
          <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span id="loadingText">æ­£åœ¨ç”ŸæˆæŠ¥å‘Šï¼Œè¯·ç¨å€™...</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div id="progressBar" class="progress-bar h-2.5 rounded-full" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <div id="report" class="bg-white shadow-md rounded p-6 mt-6 hidden">
      <div class="flex items-start mb-4">
        <img id="playerAvatar" src="" class="w-16 h-16 rounded-full mr-3" alt="ç©å®¶å¤´åƒ">
        <div>
          <h2 id="playerName" class="text-xl font-bold"></h2>
          <p id="playerInfo" class="text-gray-600 text-sm"></p>
        </div>
      </div>
      
      <div class="mb-4">
        <h3 class="text-lg font-semibold mb-2">æ¸¸æˆåº“æ¦‚è§ˆ</h3>
        <div id="gamesOverview" class="flex flex-wrap gap-1"></div>
      </div>
      
      <h3 class="text-lg font-semibold mb-2">æ¯’èˆŒé”è¯„</h3>
      <div id="reportContent" class="whitespace-pre-wrap mb-4"></div>
      
      <div class="flex justify-between">
        <button onclick="copyReport()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
          ğŸ“‹ å¤åˆ¶å†…å®¹
        </button>
        <button onclick="downloadReport()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          ğŸ“¥ ä¸‹è½½å›¾ç‰‡
        </button>
      </div>
    </div>

    <!-- æˆªå›¾ä¸“ç”¨éšè—åŒºåŸŸ -->
    <div id="report-for-capture">
      <div class="flex items-start mb-3">
        <img id="playerAvatar-capture" src="" class="w-14 h-14 rounded-full mr-3" alt="ç©å®¶å¤´åƒ">
        <div>
          <h2 id="playerName-capture" class="text-lg font-bold"></h2>
          <p id="playerInfo-capture" class="text-gray-600 text-xs"></p>
        </div>
      </div>
      
      <div class="mb-3">
        <h3 class="text-base font-semibold mb-1">æ¸¸æˆåº“æ¦‚è§ˆ</h3>
        <div id="gamesOverview-capture" class="flex flex-wrap gap-1"></div>
      </div>
      
      <h3 class="text-base font-semibold mb-1">æ¯’èˆŒé”è¯„</h3>
      <div id="reportContent-capture"></div>
    </div>
  </div>

  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    // å¸¦è¶…æ—¶æ§åˆ¶çš„ fetchï¼ˆé»˜è®¤ 10 åˆ†é’Ÿï¼‰
async function fetchWithTimeout(resource, options = {}, timeout = 600000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  try {
    const response = await fetch(resource, {
      ...options,
      signal: controller.signal
    });
    clearTimeout(id);
    return response;
  } catch (error) {
    clearTimeout(id);
    if (error.name === "AbortError") {
      throw new Error("è¯·æ±‚è¶…æ—¶ï¼ŒAIæ„æ€æ—¶é—´å¯èƒ½ç¨é•¿ï¼Œè¯·é‡è¯•æˆ–ç¨åå†æ¥~");
    }
    throw error;
  }
}

let progressInterval;
function startProgressSimulation() {
  let progress = 30;
  progressInterval = setInterval(() => {
    if (progress < 85) {
      progress += Math.random() * 3;
      updateProgress(progress);
    }
  }, 800);
}

function stopProgressSimulation() {
  clearInterval(progressInterval);
}

function showLoading(text) {
  const messages = [
    "AIæ­£åœ¨è®¤çœŸè¯„ä¼°ä½ çš„æ¸¸æˆäººç”Ÿ...",
    "ç¨å®‰å‹¿èºï¼Œæ¯’èˆŒå³å°†ä¸Šçº¿...",
    "ç”Ÿæˆä¸­ï¼Œå¯èƒ½éœ€è¦1åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚",
    "æœåŠ¡å™¨åŠªåŠ›è®½åˆºä¸­ï¼Œè¯·ç¨ç­‰~"
  ];
  document.getElementById("loadingText").textContent = text || messages[Math.floor(Math.random() * messages.length)];
  document.getElementById("loading").classList.remove("hidden");
  document.getElementById("generateBtn").disabled = true;
}

function hideLoading() {
  document.getElementById("loading").classList.add("hidden");
  document.getElementById("generateBtn").disabled = false;
}

function updateProgress(percent) {
  document.getElementById("progressBar").style.width = `${percent}%`;
}

// ç”Ÿæˆæ–°æŠ¥å‘Š
async function generateReview(forceRefresh) {
  const steamId = document.getElementById("steamIdInput").value.trim();
  if (!steamId) return;

  isGenerating = true;
  showLoading(forceRefresh ? "æ­£åœ¨ç”Ÿæˆå…¨æ–°æŠ¥å‘Š..." : "æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...");
  document.getElementById("report").classList.add("hidden");

  try {
    updateProgress(10);
    await delay(300);

    updateProgress(30);
    startProgressSimulation(); // å¯åŠ¨æ¨¡æ‹Ÿè¿›åº¦

    const url = `/api/review?steamid=${encodeURIComponent(steamId)}${forceRefresh ? '&force=true' : ''}&_=${Date.now()}`;
    const response = await fetchWithTimeout(url, {}, 600000); // æœ€é•¿ç­‰10åˆ†é’Ÿ

    stopProgressSimulation(); // è¯·æ±‚å›æ¥å°±åœæ‰æ¨¡æ‹Ÿè¿›åº¦
    updateProgress(70);

    if (!response.ok) throw new Error(await response.text());

    const data = await response.json();
    updateProgress(90);
    updateUI(data);
    updateProgress(100);
    await delay(300);
  } catch (error) {
    stopProgressSimulation(); // é”™è¯¯ä¹Ÿè®°å¾—åœæ‰
    alert(`ç”Ÿæˆå¤±è´¥: ${error.message}`);
  } finally {
    isGenerating = false;
    hideLoading();
  }
}


function stopProgressSimulation() {
  clearInterval(progressInterval);
}


    let isGenerating = false;

    // åŠ è½½å·²æœ‰æ•°æ®
async function loadExistingData(steamId) {
  showLoading("åŠ è½½å·²æœ‰æ•°æ®...");
  try {
    const response = await fetch(`/api/review?steamid=${encodeURIComponent(steamId)}&_=${Date.now()}`);
    if (!response.ok) throw new Error(await response.text());
    
    const data = await response.json();
    updateUI(data);
  } catch (error) {
    alert(`åŠ è½½æ•°æ®å¤±è´¥: ${error.message}`);
  }
}

// æ£€æŸ¥æ˜¯å¦å­˜åœ¨å·²æœ‰æ•°æ®
async function checkExistingData() {
  const steamId = document.getElementById("steamIdInput").value.trim();
  if (!steamId) {
    alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ Steam ID");
    return;
  }

  showLoading("æ£€æŸ¥å·²æœ‰æ•°æ®...");
  
  try {
    const response = await fetch(`/api/check-data?steamid=${encodeURIComponent(steamId)}&_=${Date.now()}`);
    if (!response.ok) throw new Error(await response.text());
    
    const result = await response.json();
    if (result.exists) {
      const shouldRefresh = confirm("æ£€æµ‹åˆ°å·²æœ‰æ•°æ®ï¼Œæ˜¯å¦é‡æ–°ç”Ÿæˆï¼Ÿ\n(å–æ¶ˆå°†ä½¿ç”¨ä¸Šæ¬¡ç»“æœ)");
      if (shouldRefresh) {
        await generateReview(true);
      } else {
        await loadExistingData(steamId);
      }
    } else {
      await generateReview(false);
    }
  } catch (error) {
    alert(`æ£€æŸ¥æ•°æ®å¤±è´¥: ${error.message}`);
  } finally {
    hideLoading();
  }
}


    // æ›´æ–°UIæ˜¾ç¤º
    function updateUI(data) {
      document.getElementById("playerAvatar").src = data.player.avatarfull;
      document.getElementById("playerAvatar-capture").src = data.player.avatarfull;
      
      document.getElementById("playerName").textContent = data.player.personaname;
      document.getElementById("playerName-capture").textContent = data.player.personaname;
      
      const registerDate = new Date(data.player.timecreated * 1000).toLocaleDateString();
      document.getElementById("playerInfo").textContent = `æ³¨å†Œæ—¶é—´: ${registerDate} | æ¸¸æˆæ•°: ${data.games.length}`;
      document.getElementById("playerInfo-capture").textContent = `æ³¨å†Œæ—¶é—´: ${registerDate} | æ¸¸æˆæ•°: ${data.games.length}`;
      
      // æ˜¾ç¤ºæ¸¸æˆæ¦‚è§ˆ
      const gamesHtml = data.games.slice(0, 12).map(game => 
        `<div class="game-item">${game.name} <span class="text-gray-500">(${(game.playtime_forever/60).toFixed(1)}h)</span></div>`
      ).join("");
      
      document.getElementById("gamesOverview").innerHTML = gamesHtml;
      document.getElementById("gamesOverview-capture").innerHTML = gamesHtml;
      
      // æ˜¾ç¤ºé”è¯„
      document.getElementById("reportContent").innerHTML = data.review;
      document.getElementById("reportContent-capture").innerHTML = data.review;
      
      document.getElementById("report").classList.remove("hidden");
    }


    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function copyReport() {
      const reportContent = document.getElementById("reportContent");
      navigator.clipboard.writeText(reportContent.textContent)
        .then(() => alert("å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"))
        .catch(err => alert("å¤åˆ¶å¤±è´¥: " + err));
    }

    async function downloadReport() {
      try {
        showLoading("æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...");
        
        const captureDiv = document.getElementById("report-for-capture");
    
        // ä¸´æ—¶å±•ç¤ºæˆªå›¾åŒºåŸŸ
        captureDiv.style.position = "static";
        captureDiv.style.left = "auto";
    
        // ç­‰å¾…æ ·å¼æ¸²æŸ“
        await delay(100);
    
        const canvas = await html2canvas(captureDiv, {
          scale: 2,
          logging: false,
          useCORS: true,
          backgroundColor: "#ffffff",
          windowWidth: 650,
          windowHeight: captureDiv.scrollHeight + 20
        });
    
        // éšè—æˆªå›¾åŒºåŸŸ
        captureDiv.style.position = "absolute";
        captureDiv.style.left = "-9999px";
    
        const link = document.createElement("a");
        link.download = `Steamé”è¯„_${document.getElementById("playerName").textContent}_${new Date().toISOString().slice(0,10)}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
      } catch (error) {
        alert("ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•");
      } finally {
        hideLoading();
      }
    }
    
  </script>
</body>
</html>